<section class="page detail">
  <a routerLink="/projects" class="back-link">&lt; Back to projects</a>

  <div *ngIf="loading" class="status state-loading detail-status">
    <span class="dot"></span>
    <span>Loading project...</span>
  </div>

  <div *ngIf="!loading && errorMessage" class="status state-error detail-status">
    {{ errorMessage }}
  </div>

  <article *ngIf="!loading && !errorMessage && project" class="detail-card">
    <header class="detail-card__header">
      <div>
        <p class="eyebrow">Project</p>
        <h1>{{ project.name }}</h1>
      </div>
      <span class="badge" *ngIf="etaDaysDisplay !== undefined">
        ETA {{ etaDaysDisplay }} day{{ etaDaysDisplay === 1 ? '' : 's' }}
      </span>
    </header>

    <dl class="info-grid">
      <div>
        <dt>Address</dt>
        <dd>{{ project.address || 'N/A' }}</dd>
      </div>
      <div>
        <dt>Budget</dt>
        <dd>{{ project.budget | currency:'USD':'symbol-narrow':'1.0-0' }}</dd>
      </div>
      <div>
        <dt>Contractor</dt>
        <dd>{{ project.contractorName || project.contractor || 'Unassigned' }}</dd>
      </div>
      <div>
        <dt>Workforce</dt>
        <dd>{{ workforceCount }} workers</dd>
      </div>
    </dl>

    <div class="progress progress--detail">
      <div class="progress__label">
        <span>Progress</span>
        <span>{{ project.progress ?? 0 }}%</span>
      </div>
      <div class="progress__track">
        <div class="progress__fill" [style.width.%]="project.progress ?? 0"></div>
      </div>
    </div>

    <div class="settings-toggle">
      <button type="button" class="primary" (click)="openSettings()" [disabled]="settingsOpen">
        Edit project settings
      </button>
    </div>

    <div class="modal-backdrop" *ngIf="settingsOpen" (click)="closeSettings()">
      <section class="settings settings-modal" [formGroup]="projectForm" (click)="$event.stopPropagation()">
        <header class="settings-modal__header">
          <div>
            <h2>Project Settings</h2>
            <p class="meta-hint">Adjusting progress, workforce, or contractor expertise recalculates the ETA automatically.</p>
          </div>
          <button type="button" class="link-btn" (click)="closeSettings()">Close</button>
        </header>

        <div class="settings-grid">
          <label class="input-block">
            <span>Name</span>
            <input type="text" formControlName="name">
            <button type="button" (click)="updateField('name')" [disabled]="fieldSaving.name">
              {{ fieldSaving.name ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Address</span>
            <input type="text" formControlName="address">
            <button type="button" (click)="updateField('address')" [disabled]="fieldSaving.address">
              {{ fieldSaving.address ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Budget</span>
            <input type="number" formControlName="budget" min="0">
            <button type="button" (click)="updateField('budget')" [disabled]="fieldSaving.budget">
              {{ fieldSaving.budget ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>ETA (weeks, baseline)</span>
            <input type="number" formControlName="eta" min="0" step="0.1">
            <button type="button" (click)="updateField('eta')" [disabled]="fieldSaving.eta">
              {{ fieldSaving.eta ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Workers</span>
            <input type="number" formControlName="number_of_workers" min="0">
            <button type="button" (click)="updateField('number_of_workers')" [disabled]="fieldSaving.number_of_workers">
              {{ fieldSaving.number_of_workers ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Progress {{ projectForm.get('progress')?.value }}%</span>
            <input type="range" formControlName="progress" min="0" max="99">
            <button type="button" (click)="updateField('progress')" [disabled]="fieldSaving.progress">
              {{ fieldSaving.progress ? 'Saving...' : 'Update' }}
            </button>
          </label>
        </div>

        <div class="contractor-panel">
          <div class="contractor-header">
            <div>
              <p>Assign Contractor</p>
              <small *ngIf="contractorsLoading">Loading contractors...</small>
              <small *ngIf="contractorsError" class="error-text">{{ contractorsError }}</small>
            </div>
            <button type="button" class="link-btn" (click)="clearContractor()" [disabled]="contractorSaving || !project || !project.contractor">
              Remove
            </button>
          </div>

          <select [formControl]="contractorControl" [disabled]="contractorsLoading || contractorSaving">
            <option value="">Unassigned</option>
            <option *ngFor="let contractor of contractors" [value]="contractor.id">
              {{ contractor.fullName }} Æ’?" {{ contractor.expertise }}
            </option>
          </select>

          <button type="button" class="primary" (click)="applyContractor()" [disabled]="contractorSaving">
            {{ contractorSaving ? 'Saving...' : 'Save Contractor' }}
          </button>
        </div>
      </section>
    </div>

    <section class="tasks">
      <header>
        <h2>Tasks</h2>
        <span class="badge badge--muted">{{ tasks.length }}</span>
      </header>

      <div *ngIf="tasksLoading" class="status state-loading detail-status">
        <span class="dot"></span>
        <span>Loading tasks...</span>
      </div>

      <div *ngIf="!tasksLoading && tasksError" class="status state-error detail-status">
        {{ tasksError }}
      </div>

      <p *ngIf="!tasksLoading && !tasksError && !tasks.length" class="tasks__empty">
        No tasks have been added to this project yet.
      </p>

      <div *ngIf="!tasksLoading && !tasksError && tasks.length" class="tasks__content">
        <ul class="task-links">
          <li *ngFor="let task of tasks; trackBy: trackByTaskId">
            <button type="button"
                    class="task-link"
                    [class.task-link--active]="task.id === activeTask?.id"
                    (click)="selectTask(task)">
              <span>{{ task.name }}</span>
              <span class="status-pill" [attr.data-status]="task.status">
                {{ formatStatus(task.status) }}
              </span>
            </button>
          </li>
        </ul>

        <article *ngIf="activeTask" class="task-detail">
          <h3>{{ activeTask.name }}</h3>
          <dl>
            <div>
              <dt>Status</dt>
              <dd>{{ formatStatus(activeTask.status) }}</dd>
            </div>
            <div>
              <dt>Task ID</dt>
              <dd>{{ activeTask.id }}</dd>
            </div>
            <div>
              <dt>Project ID</dt>
              <dd>{{ activeTask.projectId }}</dd>
            </div>
            <div *ngIf="activeTask.description">
              <dt>Description</dt>
              <dd>{{ activeTask.description }}</dd>
            </div>
          </dl>
        </article>
      </div>
    </section>
  </article>
</section>

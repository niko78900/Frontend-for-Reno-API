<section class="page detail">
  <div class="detail-topbar">
    <a routerLink="/projects" class="back-link">&lt; Back to projects</a>
    <a routerLink="/" class="home-link">Home</a>
  </div>

  <div *ngIf="loading" class="status state-loading detail-status">
    <span class="dot"></span>
    <span>Loading project...</span>
  </div>

  <div *ngIf="!loading && errorMessage" class="status state-error detail-status">
    {{ errorMessage }}
  </div>

  <article *ngIf="!loading && !errorMessage && project" class="detail-card">
    <header class="detail-card__header">
      <div>
        <p class="eyebrow">Project</p>
        <h1 [class.project-title--done]="projectFinished">{{ project.name }}</h1>
      </div>
      <div class="detail-card__badges">
        <span class="badge" *ngIf="etaDaysDisplay !== undefined && !projectFinished">
          ETA {{ etaDaysDisplay }} day{{ etaDaysDisplay === 1 ? '' : 's' }}
        </span>
        <span class="badge badge--muted" *ngIf="projectFinished">Completed</span>
      </div>
    </header>

    <dl class="info-grid">
      <div>
        <dt>Address</dt>
        <dd>{{ project.address || 'N/A' }}</dd>
      </div>
      <div>
        <dt>Budget</dt>
        <dd>{{ project.budget | currency:'USD':'symbol-narrow':'1.0-0' }}</dd>
      </div>
      <div>
        <dt>Contractor</dt>
        <dd>{{ project.contractorName || project.contractor || 'Unassigned' }}</dd>
      </div>
      <div>
        <dt>Workforce</dt>
        <dd>{{ workforceCount }} workers</dd>
      </div>
    </dl>

    <div class="progress progress--detail">
      <div class="progress__label">
        <span>Progress</span>
        <span>{{ taskCompletionPercent }}%</span>
      </div>
      <div class="progress__track">
        <div class="progress__fill" [style.width.%]="taskCompletionPercent"></div>
      </div>
    </div>

    <div class="project-actions">
      <button type="button"
              class="finish-btn"
              (click)="finishProject()"
              [disabled]="!canFinishProject || finishProjectSaving">
        {{ projectFinished ? 'Project finished' : (finishProjectSaving ? 'Finishing...' : 'Finish project') }}
      </button>
      <span class="project-actions__hint" *ngIf="!projectFinished && taskCompletionPercent < 99">
        Complete all tasks to finish.
      </span>
    </div>

    <div class="settings-toggle">
      <button type="button" class="primary" (click)="openSettings()" [disabled]="settingsOpen">
        Edit project settings
      </button>
      <button type="button"
              class="danger"
              (click)="deleteProject()"
              [disabled]="deletingProject || !project?.id">
        {{ deletingProject ? 'Deleting...' : 'Delete project' }}
      </button>
    </div>

    <div class="modal-backdrop" *ngIf="settingsOpen" (click)="closeSettings()">
      <section class="settings settings-modal" [formGroup]="projectForm" (click)="$event.stopPropagation()">
        <header class="settings-modal__header">
          <div>
            <h2>Project Settings</h2>
            <p class="meta-hint">Adjusting progress, workforce, or contractor expertise recalculates the ETA automatically.</p>
          </div>
          <div class="settings-modal__actions">
            <a routerLink="/" class="link-btn">Home</a>
            <button type="button" class="link-btn" (click)="closeSettings()">Close</button>
          </div>
        </header>

        <div class="settings-grid">
          <label class="input-block" [class.input-block--disabled]="isFieldLocked('name')">
            <span>Name</span>
            <input type="text" formControlName="name" [disabled]="isFieldLocked('name')">
            <button type="button"
                    (click)="updateField('name')"
                    [disabled]="fieldSaving.name || isFieldLocked('name')"
                    [class.locked-control]="isFieldLocked('name')">
              {{ fieldSaving.name ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block" [class.input-block--disabled]="isFieldLocked('address')">
            <span>Address</span>
            <input type="text"
                   formControlName="address"
                   [disabled]="isFieldLocked('address')"
                   [class.locked-control]="isFieldLocked('address')">
            <button type="button"
                    (click)="updateField('address')"
                    [disabled]="fieldSaving.address || isFieldLocked('address')"
                    [class.locked-control]="isFieldLocked('address')">
              {{ fieldSaving.address ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block" [class.input-block--disabled]="isFieldLocked('budget')">
            <span>Budget</span>
            <input type="number"
                   formControlName="budget"
                   min="0"
                   [disabled]="isFieldLocked('budget')"
                   [class.locked-control]="isFieldLocked('budget')">
            <button type="button"
                    (click)="updateField('budget')"
                    [disabled]="fieldSaving.budget || isFieldLocked('budget')"
                    [class.locked-control]="isFieldLocked('budget')">
              {{ fieldSaving.budget ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block" [class.input-block--disabled]="isFieldLocked('eta')">
          <span>ETA (weeks, baseline)</span>
          <input type="number"
                 formControlName="eta"
                 min="0"
                 step="1"
                 [disabled]="isFieldLocked('eta')"
                 [class.locked-control]="isFieldLocked('eta')">
            <button type="button"
                    (click)="updateField('eta')"
                    [disabled]="fieldSaving.eta || isFieldLocked('eta')"
                    [class.locked-control]="isFieldLocked('eta')">
              {{ fieldSaving.eta ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block" [class.input-block--disabled]="isFieldLocked('number_of_workers')">
            <span>Workers</span>
            <input type="number"
                   formControlName="number_of_workers"
                   min="0"
                   [disabled]="isFieldLocked('number_of_workers')"
                   [class.locked-control]="isFieldLocked('number_of_workers')">
            <button type="button"
                    (click)="updateField('number_of_workers')"
                    [disabled]="fieldSaving.number_of_workers || isFieldLocked('number_of_workers')"
                    [class.locked-control]="isFieldLocked('number_of_workers')">
              {{ fieldSaving.number_of_workers ? 'Saving...' : 'Update' }}
            </button>
          </label>
        </div>

        <section class="location-section">
          <div class="location-section__header">
            <div>
              <h3>Project location</h3>
              <p class="location-section__hint">We place the marker for you from the address. Drag to fine-tune and save.</p>
            </div>
            <div class="location-section__chips">
              <span class="chip" *ngIf="geocodingAddress">Looking up address...</span>
              <span class="chip chip--muted" *ngIf="!locationCoordinates && !geocodingAddress">Location not set</span>
            </div>
          </div>

          <app-project-location-map
            [addressLabel]="projectForm.get('address')?.value || project.address"
            [coordinates]="locationCoordinates"
            (coordinatesChange)="onLocationChanged($event)">
          </app-project-location-map>

          <div class="location-section__actions">
            <button type="button"
                    class="ghost-btn"
                    (click)="refreshLocationFromAddress()"
                    [disabled]="geocodingAddress || isFieldLocked('address')">
              {{ geocodingAddress ? 'Geocoding...' : 'Refresh from address' }}
            </button>
            <button type="button"
                    class="primary"
                    (click)="saveLocation()"
                    [disabled]="locationSaving || !locationCoordinates || isLocked()">
              {{ locationSaving ? 'Saving...' : 'Save location' }}
            </button>
          </div>

          <p *ngIf="locationError" class="error-text">{{ locationError }}</p>
          <p *ngIf="!locationError" class="location-hint">{{ locationMessage }}</p>
        </section>

        <div class="contractor-panel" [class.contractor-panel--disabled]="isLocked()">
          <div class="contractor-header">
            <div>
              <p>Assign Contractor</p>
              <small *ngIf="contractorsLoading">Loading contractors...</small>
              <small *ngIf="contractorsError" class="error-text">{{ contractorsError }}</small>
              <small *ngIf="laborError" class="error-text">{{ laborError }}</small>
            </div>
            <button type="button" class="link-btn" (click)="clearContractor()" [disabled]="contractorSaving || !project || !project.contractor || isLocked()">
              Remove
            </button>
          </div>

          <select [formControl]="contractorControl" [disabled]="contractorsLoading || contractorSaving || isLocked()" [class.input-disabled]="isLocked()">
            <option value="">Unassigned</option>
            <option *ngFor="let contractor of contractors" [value]="contractor.id">
              {{ contractor.fullName }} - {{ contractor.expertise }}
            </option>
          </select>

          <button type="button" class="primary" (click)="applyContractor()" [disabled]="contractorSaving || isLocked()">
            {{ contractorSaving ? 'Saving...' : 'Save Contractor' }}
          </button>
        </div>
      </section>
    </div>

    <section class="tasks">
      <header class="tasks__header">
        <div>
          <h2>Tasks</h2>
          <p class="tasks__hint">Create, update, or remove task items tied to this renovation.</p>
        </div>
      <div class="tasks__actions">
        <span class="badge badge--muted">{{ tasks.length }}</span>
        <button type="button"
                class="primary"
                (click)="openTaskPanel()"
                [disabled]="taskPanelOpen || isLocked()"
                [class.locked-control]="isLocked()">
          Add task
        </button>
      </div>
    </header>

      <div *ngIf="taskPanelOpen" class="task-panel" [formGroup]="taskForm">
        <div class="task-panel__fields">
          <label class="input-block">
            <span>Task name</span>
            <input type="text" formControlName="name" placeholder="Install wiring" [disabled]="isLocked()">
          </label>
          <label class="input-block">
            <span>Status</span>
            <select formControlName="status" [disabled]="isLocked()">
              <option *ngFor="let status of taskStatuses" [value]="status">{{ formatStatus(status) }}</option>
            </select>
          </label>
        </div>
        <div class="task-panel__actions">
          <button type="button"
                  class="ghost-btn"
                  (click)="closeTaskPanel()"
                  [class.locked-control]="isLocked()"
                  [disabled]="isLocked()">
            Cancel
          </button>
          <button type="button"
                  class="primary"
                  (click)="createTask()"
                  [disabled]="taskSaving || taskForm.invalid || isLocked()"
                  [class.locked-control]="isLocked()">
            {{ taskSaving ? 'Creating...' : 'Create task' }}
          </button>
        </div>
        <p *ngIf="taskActionError" class="error-text">{{ taskActionError }}</p>
      </div>

      <div *ngIf="tasksLoading" class="status state-loading detail-status">
        <span class="dot"></span>
        <span>Loading tasks...</span>
      </div>

      <div *ngIf="!tasksLoading && tasksError" class="status state-error detail-status">
        {{ tasksError }}
      </div>

      <p *ngIf="!tasksLoading && !tasksError && !tasks.length" class="tasks__empty">
        No tasks have been added to this project yet.
      </p>

      <p *ngIf="!tasksLoading && !tasksError && tasks.length && taskActionError" class="error-text">
        {{ taskActionError }}
      </p>

      <ul *ngIf="!tasksLoading && !tasksError && tasks.length" class="task-list">
        <li class="task-item" *ngFor="let task of tasks; trackBy: trackByTaskId">
          <div class="task-item__main">
            <div>
              <h3>{{ task.name }}</h3>
              <p class="task-item__meta">Task ID {{ task.id }}</p>
            </div>
            <span class="status-pill" [attr.data-status]="task.status">
              {{ formatStatus(task.status) }}
            </span>
          </div>

          <div class="task-item__actions">
            <label class="task-status">
              <span>Status</span>
              <select [value]="getTaskStatusDraft(task)"
                      (change)="setTaskStatusDraft(task, $any($event.target).value)"
                      [disabled]="isLocked()">
                <option *ngFor="let status of taskStatuses" [value]="status">{{ formatStatus(status) }}</option>
              </select>
            </label>
            <button type="button"
                    class="secondary"
                    (click)="updateTaskStatus(task)"
                    [disabled]="taskStatusSaving[task.id] || isLocked()"
                    [class.locked-control]="isLocked()">
              {{ taskStatusSaving[task.id] ? 'Saving...' : 'Change status' }}
            </button>
            <button type="button"
                    class="danger"
                    (click)="confirmRemoveTask(task)"
                    [disabled]="taskRemoving[task.id] || isLocked()"
                    [class.locked-control]="isLocked()">
              {{ taskRemoving[task.id] ? 'Removing...' : 'Remove' }}
            </button>
          </div>
        </li>
      </ul>
    </section>
  </article>
</section>

<section class="page detail">
  <a routerLink="/projects" class="back-link">&lt; Back to projects</a>

  <div *ngIf="loading" class="status state-loading detail-status">
    <span class="dot"></span>
    <span>Loading project...</span>
  </div>

  <div *ngIf="!loading && errorMessage" class="status state-error detail-status">
    {{ errorMessage }}
  </div>

  <article *ngIf="!loading && !errorMessage && project" class="detail-card">
    <header class="detail-card__header">
      <div>
        <p class="eyebrow">Project</p>
        <h1 [class.project-title--done]="projectFinished">{{ project.name }}</h1>
      </div>
      <div class="detail-card__badges">
        <span class="badge" *ngIf="etaDaysDisplay !== undefined && !projectFinished">
          ETA {{ etaDaysDisplay }} day{{ etaDaysDisplay === 1 ? '' : 's' }}
        </span>
        <span class="badge badge--muted" *ngIf="projectFinished">Completed</span>
      </div>
    </header>

    <dl class="info-grid">
      <div>
        <dt>Address</dt>
        <dd>{{ project.address || 'N/A' }}</dd>
      </div>
      <div>
        <dt>Budget</dt>
        <dd>{{ project.budget | currency:'USD':'symbol-narrow':'1.0-0' }}</dd>
      </div>
      <div>
        <dt>Contractor</dt>
        <dd>{{ project.contractorName || project.contractor || 'Unassigned' }}</dd>
      </div>
      <div>
        <dt>Workforce</dt>
        <dd>{{ workforceCount }} workers</dd>
      </div>
    </dl>

    <div class="progress progress--detail">
      <div class="progress__label">
        <span>Progress</span>
        <span>{{ taskCompletionPercent }}%</span>
      </div>
      <div class="progress__track">
        <div class="progress__fill" [style.width.%]="taskCompletionPercent"></div>
      </div>
    </div>

    <div class="project-actions">
      <button type="button"
              class="finish-btn"
              (click)="finishProject()"
              [disabled]="!canFinishProject || finishProjectSaving">
        {{ projectFinished ? 'Project finished' : (finishProjectSaving ? 'Finishing...' : 'Finish project') }}
      </button>
      <span class="project-actions__hint" *ngIf="!projectFinished && taskCompletionPercent < 99">
        Complete all tasks to finish.
      </span>
    </div>

    <div class="settings-toggle">
      <button type="button" class="primary" (click)="openSettings()" [disabled]="settingsOpen">
        Edit project settings
      </button>
    </div>

    <div class="modal-backdrop" *ngIf="settingsOpen" (click)="closeSettings()">
      <section class="settings settings-modal" [formGroup]="projectForm" (click)="$event.stopPropagation()">
        <header class="settings-modal__header">
          <div>
            <h2>Project Settings</h2>
            <p class="meta-hint">Adjusting progress, workforce, or contractor expertise recalculates the ETA automatically.</p>
          </div>
          <button type="button" class="link-btn" (click)="closeSettings()">Close</button>
        </header>

        <div class="settings-grid">
          <label class="input-block">
            <span>Name</span>
            <input type="text" formControlName="name">
            <button type="button" (click)="updateField('name')" [disabled]="fieldSaving.name">
              {{ fieldSaving.name ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Address</span>
            <input type="text" formControlName="address">
            <button type="button" (click)="updateField('address')" [disabled]="fieldSaving.address">
              {{ fieldSaving.address ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Budget</span>
            <input type="number" formControlName="budget" min="0">
            <button type="button" (click)="updateField('budget')" [disabled]="fieldSaving.budget">
              {{ fieldSaving.budget ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
          <span>ETA (weeks, baseline)</span>
          <input type="number" formControlName="eta" min="0" step="1">
            <button type="button" (click)="updateField('eta')" [disabled]="fieldSaving.eta">
              {{ fieldSaving.eta ? 'Saving...' : 'Update' }}
            </button>
          </label>

          <label class="input-block">
            <span>Workers</span>
            <input type="number" formControlName="number_of_workers" min="0">
            <button type="button" (click)="updateField('number_of_workers')" [disabled]="fieldSaving.number_of_workers">
              {{ fieldSaving.number_of_workers ? 'Saving...' : 'Update' }}
            </button>
          </label>
        </div>

        <div class="contractor-panel">
          <div class="contractor-header">
            <div>
              <p>Assign Contractor</p>
              <small *ngIf="contractorsLoading">Loading contractors...</small>
              <small *ngIf="contractorsError" class="error-text">{{ contractorsError }}</small>
              <small *ngIf="laborError" class="error-text">{{ laborError }}</small>
            </div>
            <button type="button" class="link-btn" (click)="clearContractor()" [disabled]="contractorSaving || !project || !project.contractor">
              Remove
            </button>
          </div>

          <select [formControl]="contractorControl" [disabled]="contractorsLoading || contractorSaving">
            <option value="">Unassigned</option>
            <option *ngFor="let contractor of contractors" [value]="contractor.id || contractor._id">
              {{ contractor.fullName }} - {{ contractor.expertise }}
            </option>
          </select>

          <button type="button" class="primary" (click)="applyContractor()" [disabled]="contractorSaving">
            {{ contractorSaving ? 'Saving...' : 'Save Contractor' }}
          </button>
        </div>
      </section>
    </div>

    <section class="tasks">
      <header class="tasks__header">
        <div>
          <h2>Tasks</h2>
          <p class="tasks__hint">Create, update, or remove task items tied to this renovation.</p>
        </div>
        <div class="tasks__actions">
          <span class="badge badge--muted">{{ tasks.length }}</span>
          <button type="button" class="primary" (click)="openTaskPanel()" [disabled]="taskPanelOpen">
            Add task
          </button>
        </div>
      </header>

      <div *ngIf="taskPanelOpen" class="task-panel" [formGroup]="taskForm">
        <div class="task-panel__fields">
          <label class="input-block">
            <span>Task name</span>
            <input type="text" formControlName="name" placeholder="Install wiring">
          </label>
          <label class="input-block">
            <span>Status</span>
            <select formControlName="status">
              <option *ngFor="let status of taskStatuses" [value]="status">{{ formatStatus(status) }}</option>
            </select>
          </label>
        </div>
        <div class="task-panel__actions">
          <button type="button" class="ghost-btn" (click)="closeTaskPanel()">Cancel</button>
          <button type="button" class="primary" (click)="createTask()" [disabled]="taskSaving || taskForm.invalid">
            {{ taskSaving ? 'Creating...' : 'Create task' }}
          </button>
        </div>
        <p *ngIf="taskActionError" class="error-text">{{ taskActionError }}</p>
      </div>

      <div *ngIf="tasksLoading" class="status state-loading detail-status">
        <span class="dot"></span>
        <span>Loading tasks...</span>
      </div>

      <div *ngIf="!tasksLoading && tasksError" class="status state-error detail-status">
        {{ tasksError }}
      </div>

      <p *ngIf="!tasksLoading && !tasksError && !tasks.length" class="tasks__empty">
        No tasks have been added to this project yet.
      </p>

      <p *ngIf="!tasksLoading && !tasksError && tasks.length && taskActionError" class="error-text">
        {{ taskActionError }}
      </p>

      <ul *ngIf="!tasksLoading && !tasksError && tasks.length" class="task-list">
        <li class="task-item" *ngFor="let task of tasks; trackBy: trackByTaskId">
          <div class="task-item__main">
            <div>
              <h3>{{ task.name }}</h3>
              <p class="task-item__meta">Task ID {{ task.id }}</p>
            </div>
            <span class="status-pill" [attr.data-status]="task.status">
              {{ formatStatus(task.status) }}
            </span>
          </div>

          <div class="task-item__actions">
            <label class="task-status">
              <span>Status</span>
              <select [value]="getTaskStatusDraft(task)"
                      (change)="setTaskStatusDraft(task, $any($event.target).value)">
                <option *ngFor="let status of taskStatuses" [value]="status">{{ formatStatus(status) }}</option>
              </select>
            </label>
            <button type="button"
                    class="secondary"
                    (click)="updateTaskStatus(task)"
                    [disabled]="taskStatusSaving[task.id]">
              {{ taskStatusSaving[task.id] ? 'Saving...' : 'Change status' }}
            </button>
            <button type="button"
                    class="danger"
                    (click)="confirmRemoveTask(task)"
                    [disabled]="taskRemoving[task.id]">
              {{ taskRemoving[task.id] ? 'Removing...' : 'Remove' }}
            </button>
          </div>
        </li>
      </ul>
    </section>
  </article>
</section>
